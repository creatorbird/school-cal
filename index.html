<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ Account Pro</title>
  <style>
    :root { --main: #007bff; --admin: #dc3545; --bg: #f8f9fa; --today: #e7f3ff; --accent: #ff9f43; --selected: #007bff; --success: #28a745; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; text-align: center; color: #333; }
    .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
    input, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { background: var(--main); color: white; border: none; font-weight: bold; cursor:pointer;}
    .btn-danger { background: var(--admin); color: white; border: none; font-size: 11px; padding: 4px 8px; width: auto; cursor:pointer; border-radius: 5px; }
    .hidden { display: none !important; }
    
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd; }
    .cal-day { background: white; min-height: 50px; font-size: 12px; padding: 2px; cursor: pointer; }
    .cal-day.today { background: var(--today); font-weight: bold; }
    
    .task { text-align: left; border-left: 5px solid var(--main); padding: 12px; background: #fff; margin-bottom: 10px; border-radius: 5px; cursor: pointer; position: relative; transition: 0.3s;}
    .task.done { opacity: 0.5; border-left-color: var(--success); background: #f0fdf4; text-decoration: line-through; }
    .done-badge { position: absolute; top: 10px; right: 10px; color: var(--success); font-weight: bold; font-size: 12px; }
    
    .user-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .user-table td, .user-table th { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
  </style>
</head>
<body>

  <div id="view-init">
    <h2>ğŸ« å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <p style="font-size:14px; color:#666;">ã¾ãšã¯ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <div class="card">
      <button class="btn-submit" onclick="showView('view-start')">ã‚²ã‚¹ãƒˆ/å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div style="margin:10px; font-size:12px;">ã¾ãŸã¯</div>
      <button style="background:#333; color:white;" onclick="showView('view-user-auth')">å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>

  <div id="view-user-auth" class="hidden">
    <h3>ğŸ‘¤ å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
    <div class="card">
      <input type="text" id="user-acc-name" placeholder="åå‰ (ä¾‹: è‡ªåˆ†ã®ãƒ•ãƒ«ãƒãƒ¼ãƒ )">
      <input type="password" id="user-acc-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ç”Ÿå¹´æœˆæ—¥ãªã©æ¨å¥¨)">
      <button class="btn-submit" onclick="userLoginAction()">ãƒ­ã‚°ã‚¤ãƒ³ / ä½œæˆ</button>
    </div>
    <button onclick="showView('view-init')">æˆ»ã‚‹</button>
  </div>

  <div id="view-start" class="hidden">
    <h3>å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <div class="card">
      <input type="text" id="login-group-name" placeholder="å›£ä½“å">
      <input type="password" id="login-group-pass" placeholder="å›£ä½“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="groupLoginAction(false)">å›£ä½“ã«å…¥ã‚‹</button>
    </div>
    <button onclick="showView('view-setup')" style="font-size:12px;">æ–°è¦å›£ä½“ã‚’è¨­ç«‹</button> | 
    <button onclick="showView('view-admin-login')" style="font-size:12px;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button><br><br>
    <button onclick="showView('view-init')">æˆ»ã‚‹</button>
  </div>

  <div id="view-setup" class="hidden">
    <h3>ğŸ—ï¸ å›£ä½“è¨­ç«‹</h3>
    <div class="card">
      <input type="text" id="setup-name" placeholder="æ–°ã—ã„å›£ä½“å">
      <input type="password" id="setup-gpass" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <input type="password" id="setup-opass" placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="createGroup()">è¨­ç«‹</button>
    </div>
    <button onclick="showView('view-start')">æˆ»ã‚‹</button>
  </div>

  <div id="view-admin-login" class="hidden">
    <h3>âš™ï¸ å›£ä½“ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <div class="card">
      <input type="text" id="admin-login-name" placeholder="å›£ä½“å">
      <input type="password" id="admin-login-pass" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="groupLoginAction(true)" style="background:var(--admin);">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <button onclick="showView('view-start')">æˆ»ã‚‹</button>
  </div>

  <div id="view-calendar" class="hidden">
    <h3 id="group-title"></h3>
    <div id="user-info-bar" style="font-size:12px; margin-bottom:10px; color:var(--main);"></div>
    <div id="admin-mode-badge" class="hidden" style="color:red; font-size:11px; margin-bottom:10px;">
        ã€ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã€‘ <button onclick="showView('view-admin-settings')" style="width:auto; padding:2px 8px; font-size:10px;">âš™ï¸ è¨­å®šãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
    </div>
    
    <div class="card" style="padding: 10px;">
      <div id="cal-grid" class="cal-grid"></div>
    </div>

    <div class="card">
      <input type="date" id="t-date">
      <input type="text" id="t-title" placeholder="äºˆå®šã®å†…å®¹">
      <button class="btn-submit" onclick="addTask()">åŒæœŸã™ã‚‹</button>
    </div>

    <div id="task-list"></div>
    <button onclick="location.reload()" style="background:#666; color:white; margin-top:20px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <div id="view-admin-settings" class="hidden">
    <h3>âš™ï¸ ç®¡ç†è€…è¨­å®š</h3>
    <div class="card">
      <h4>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åˆ¶å¤‰æ›´</h4>
      <table class="user-table">
        <thead><tr><th>åå‰</th><th>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ç”Ÿå¹´æœˆæ—¥ç­‰)</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="admin-user-list"></tbody>
      </table>
    </div>
    <button onclick="showView('view-calendar')">æˆ»ã‚‹</button>
  </div>

<script>
  const BIN_ID = "6989dd4bae596e708f1d842e";
  const API_KEY = "$2a$10$vOIMxpQkFmMIiTKTr5YlSuw1qB4Qrq3V7S51cnS9Q6b6v3K9rcKrK"; 

  let allData = { groups: {}, globalUsers: {} }; // globalUsersã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
  let currentGroup = null;
  let currentUser = null; // å€‹äººãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±
  let isAdminMode = false;
  let displayDate = new Date();

  async function syncFromCloud() {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": API_KEY } });
    const json = await res.json();
    allData = json.record || { groups: {}, globalUsers: {} };
    if(!allData.groups) allData.groups = {};
    if(!allData.globalUsers) allData.globalUsers = {};
  }

  async function syncToCloud() {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: 'PUT',
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(allData)
    });
  }

  // å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³/ä½œæˆ
  async function userLoginAction() {
    const name = document.getElementById('user-acc-name').value;
    const pass = document.getElementById('user-acc-pass').value;
    if(!name || !pass) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    await syncFromCloud();
    if(!allData.globalUsers[name]) {
        if(confirm("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ãä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) {
            allData.globalUsers[name] = { name, pass };
            await syncToCloud();
        } else { return; }
    } else {
        if(allData.globalUsers[name].pass !== pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
    currentUser = allData.globalUsers[name];
    alert(`ã“ã‚“ã«ã¡ã¯ã€${name}ã•ã‚“ï¼æ¬¡ã«å›£ä½“ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`);
    showView('view-start');
  }

  async function groupLoginAction(isOp) {
    const gName = isOp ? document.getElementById('admin-login-name').value : document.getElementById('login-group-name').value;
    const pass = isOp ? document.getElementById('admin-login-pass').value : document.getElementById('login-group-pass').value;
    await syncFromCloud();
    const g = allData.groups[gName];
    if(g && (isOp ? g.oPass === pass : g.gPass === pass)) {
      currentGroup = g;
      isAdminMode = isOp;
      // å›£ä½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã«ç´ä»˜ã‘
      if(currentUser && !currentGroup.memberNames?.includes(currentUser.name)) {
        if(!currentGroup.memberNames) currentGroup.memberNames = [];
        currentGroup.memberNames.push(currentUser.name);
        await syncToCloud();
      }
      document.getElementById('group-title').innerText = gName;
      document.getElementById('user-info-bar').innerText = currentUser ? `ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${currentUser.name}` : "ğŸ‘¤ ã‚²ã‚¹ãƒˆåˆ©ç”¨ä¸­";
      document.getElementById('admin-mode-badge').className = isAdminMode ? "" : "hidden";
      renderCalendar();
      if(isAdminMode) renderAdminUserList();
      showView('view-calendar');
    } else { alert("é–“é•ã„ãŒã‚ã‚Šã¾ã™"); }
  }

  // ç®¡ç†è€…ç”¨ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
  function renderAdminUserList() {
    const body = document.getElementById('admin-user-list');
    body.innerHTML = "";
    (currentGroup.memberNames || []).forEach(mName => {
        const u = allData.globalUsers[mName];
        if(!u) return;
        body.innerHTML += `<tr>
            <td>${mName}</td>
            <td><input type="text" id="pw-${mName}" value="${u.pass}" style="padding:5px; font-size:12px;"></td>
            <td><button class="btn-submit" style="width:auto; padding:5px; font-size:10px;" onclick="forceChangePw('${mName}')">å¤‰æ›´</button></td>
        </tr>`;
    });
  }

  async function forceChangePw(mName) {
    const newPw = document.getElementById(`pw-${mName}`).value;
    await syncFromCloud();
    allData.globalUsers[mName].pass = newPw;
    await syncToCloud();
    alert(`${mName}ã•ã‚“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
  }

  // ã‚¿ãƒƒãƒ—ã§ãƒã‚§ãƒƒã‚¯ã‚’ã¤ã‘ã‚‹ï¼ˆå€‹äººç”¨ï¼‰
  function toggleDone(taskId) {
    if(!currentUser) return alert("ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯å€‹äººãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
    let doneList = JSON.parse(localStorage.getItem(`done_${currentUser.name}`) || "[]");
    if(doneList.includes(taskId)) {
        doneList = doneList.filter(id => id !== taskId);
    } else {
        doneList.push(taskId);
    }
    localStorage.setItem(`done_${currentUser.name}`, JSON.stringify(doneList));
    renderCalendar();
  }

  async function createGroup() {
    const name = document.getElementById('setup-name').value;
    await syncFromCloud();
    allData.groups[name] = { name, gPass: document.getElementById('setup-gpass').value, oPass: document.getElementById('setup-opass').value, tasks: [], memberNames: [] };
    await syncToCloud();
    showView('view-start');
  }

  async function addTask() {
    const title = document.getElementById('t-title').value;
    const date = document.getElementById('t-date').value;
    if(!title || !date) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    await syncFromCloud();
    allData.groups[currentGroup.name].tasks.push({ id: Date.now(), title, date });
    await syncToCloud();
    currentGroup = allData.groups[currentGroup.name];
    renderCalendar();
  }

  function renderCalendar() {
    const year = displayDate.getFullYear(), month = displayDate.getMonth();
    const grid = document.getElementById('cal-grid');
    grid.innerHTML = "";
    const lastDate = new Date(year, month + 1, 0).getDate();
    for(let i=1; i<=lastDate; i++) {
      const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
      const hasT = currentGroup.tasks.some(t => t.date === dStr);
      grid.innerHTML += `<div class="cal-day">${i}${hasT?'<div style="background:red;width:5px;height:5px;border-radius:50%;margin:auto;"></div>':''}</div>`;
    }
    const list = document.getElementById('task-list');
    list.innerHTML = "";
    let doneList = currentUser ? JSON.parse(localStorage.getItem(`done_${currentUser.name}`) || "[]") : [];
    currentGroup.tasks.forEach(t => {
      const isDone = doneList.includes(t.id);
      list.innerHTML += `<div class="task ${isDone?'done':''}" onclick="toggleDone(${t.id})">
          ${isDone?'<div class="done-badge">âœ“ å®Œäº†</div>':''}
          <div style="font-size:11px;">${t.date}</div>
          <b>${t.title}</b>
      </div>`;
    });
  }

  function showView(id) {
    document.querySelectorAll('body > div').forEach(v => v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  syncFromCloud();
</script>
</body>
</html>
